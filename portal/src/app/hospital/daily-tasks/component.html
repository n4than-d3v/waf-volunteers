@if (performingRecheck) {
<div class="recheck-form">
  <h3>Perform recheck</h3>
  <p>
    ğŸ”—
    <a
      (click)="viewPatient(performingRecheck.reference, performingRecheck.species.name, performingRecheck.viewPatientId)"
      >{{ performingRecheck.reference }}</a
    >
  </p>
  <p>
    ğŸ¾ {{ performingRecheck.species.name }} ({{ performingRecheck.variant.name
    }})
  </p>
  <p>ğŸ“ {{ performingRecheck.pen.reference }}</p>
  <p>ğŸ©º {{ performingRecheck.description }}</p>
  <div class="field">
    <label for="comments">Comments</label>
    <textarea
      id="comments"
      [(ngModel)]="comments[performingRecheck.id]"
      rows="3"
    ></textarea>
  </div>
  @if (performingRecheck.requireWeight) {
  <div class="field require-weight">
    <label for="weight">
      Weight
      <span class="required">*</span>
    </label>
    <div class="input-with-units">
      <input
        id="weight"
        type="number"
        [(ngModel)]="weightValue[performingRecheck.id]"
        autocomplete="off"
      />
      <select id="weightUnit" [(ngModel)]="weightUnit[performingRecheck.id]">
        <option value="1">g</option>
        <option value="2">kg</option>
      </select>
    </div>
  </div>
  }
  <div class="hint">
    If you are using a shared device, please add your initials in the comment.
  </div>
  @if (isVet) {
  <div class="field schedule-another-recheck">
    <label for="isAddingRecheck"> Schedule another recheck </label>
    <input id="isAddingRecheck" type="checkbox" [(ngModel)]="isAddingRecheck" />
  </div>
  @if (isAddingRecheck) {
  <div class="field">
    <label for="due">
      Due
      <span class="required">*</span>
    </label>
    <input
      id="due"
      type="date"
      [(ngModel)]="newRecheckDue[performingRecheck.id]"
      autocomplete="off"
    />
  </div>
  <div class="field">
    <label for="roles">
      For
      <span class="required">*</span>
    </label>
    <select id="roles" [(ngModel)]="newRecheckRoles[performingRecheck.id]">
      <option value="1">Veterinarian</option>
      <option value="2">Technician</option>
    </select>
  </div>
  <div class="field">
    <label for="requireWeight"> Require weight </label>
    <input
      type="checkbox"
      id="requireWeight"
      [(ngModel)]="newRecheckRequireWeight[performingRecheck.id]"
    />
  </div>
  <div class="field new-recheck-description">
    <label for="description">
      Description
      <span class="required">*</span>
    </label>
    <textarea
      id="description"
      type="text"
      [(ngModel)]="newRecheckDescription[performingRecheck.id]"
      autocomplete="off"
      rows="3"
    ></textarea>
  </div>
  } } @if (invalid == performingRecheck.id) {
  <div class="error">Please fill all required fields.</div>
  }
  <div class="buttons">
    <button
      (click)="performRecheck(performingRecheck)"
      class="button button--secondary-invert"
    >
      âœ… Done
    </button>
    <button (click)="cancel()" class="button button--secondary-invert">
      â¬…ï¸ Back
    </button>
  </div>
</div>
} @else if (administeringPrescription && !undoPrescriptionAdministration) {
<div class="prescription-form">
  <h3>Administer prescription</h3>
  <p>
    ğŸ”—
    <a
      (click)="viewPatient(administeringPrescription.reference, administeringPrescription.species.name, administeringPrescription.viewPatientId)"
      >{{ administeringPrescription.reference }}</a
    >
  </p>
  <p>
    ğŸ¾ {{ administeringPrescription.species.name }} ({{
    administeringPrescription.variant.name }})
  </p>
  <p>ğŸ“ {{ administeringPrescription.pen.reference }}</p>

  @if (isPrescriptionMedication(administeringPrescription)) {
  <p>
    ğŸ’Š {{ administeringPrescription.medication.activeSubstance }} &middot; {{
    administeringPrescription.medicationConcentration.form }}, {{
    administeringPrescription.medicationConcentration.concentrationValue }} {{
    administeringPrescription.medicationConcentration.concentrationUnit }}
  </p>
  <p>
    ğŸ’‰ {{ administeringPrescription.administrationMethod.description }} ({{
    administeringPrescription.administrationMethod.code }}), {{
    administeringPrescription.quantityValue }} {{
    administeringPrescription.quantityUnit }}
  </p>
  @if (administeringPrescription.comments) {
  <p>ğŸ“‹ {{ administeringPrescription.comments }}</p>
  } } @else {
  <p>ğŸ“‹ {{ administeringPrescription.instructions }}</p>
  } @if (isPrescriptionMedication(administeringPrescription)) {
  <div class="field">
    <label for="comments-m-{{ administeringPrescription.id }}">Comments</label>
    <textarea
      id="comments-m-{{ administeringPrescription.id }}"
      [(ngModel)]="comments['M'+administeringPrescription.id]"
      rows="3"
    ></textarea>
  </div>
  <div class="hint">
    If you are using a shared device, please add your initials in the comment.
  </div>
  <div class="buttons">
    <button
      (click)="administerMedication(administeringPrescription.id, true)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âœ… Success
    </button>
    <button
      (click)="administerMedication(administeringPrescription.id, false)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âŒ Fail
    </button>
    <button (click)="cancel()" class="button button--secondary-invert">
      â¬…ï¸ Back
    </button>
  </div>
  } @else {
  <div class="field">
    <label for="comments-m-{{ administeringPrescription.id }}">Comments</label>
    <textarea
      id="comments-m-{{ administeringPrescription.id }}"
      [(ngModel)]="comments['I'+administeringPrescription.id]"
      rows="3"
    ></textarea>
  </div>
  <div class="hint">
    If you are using a shared device, please add your initials in the comment.
  </div>
  <div class="buttons">
    <button
      (click)="administerInstruction(administeringPrescription.id, true)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âœ… Success
    </button>
    <button
      (click)="administerInstruction(administeringPrescription.id, false)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âŒ Fail
    </button>
    <button (click)="cancel()" class="button button--secondary-invert">
      â¬…ï¸ Back
    </button>
  </div>
  }
</div>
} @else if (administeringPrescription && undoPrescriptionAdministration) {
<div class="prescription-form">
  <h3>Undo prescription administration</h3>
  <p>
    ğŸ”—
    <a
      (click)="viewPatient(administeringPrescription.reference, administeringPrescription.species.name, administeringPrescription.viewPatientId)"
      >{{ administeringPrescription.reference }}</a
    >
  </p>
  <p>
    ğŸ¾ {{ administeringPrescription.species.name }} ({{
    administeringPrescription.variant.name }})
  </p>
  <p>ğŸ“ {{ administeringPrescription.pen.reference }}</p>

  @if (isPrescriptionMedication(administeringPrescription)) {
  <p>
    ğŸ’Š {{ administeringPrescription.medication.activeSubstance }} &middot; {{
    administeringPrescription.medicationConcentration.form }}, {{
    administeringPrescription.medicationConcentration.concentrationValue }} {{
    administeringPrescription.medicationConcentration.concentrationUnit }}
  </p>
  <p>
    ğŸ’‰ {{ administeringPrescription.administrationMethod.description }} ({{
    administeringPrescription.administrationMethod.code }}), {{
    administeringPrescription.quantityValue }} {{
    administeringPrescription.quantityUnit }}
  </p>
  @if (administeringPrescription.comments) {
  <p>ğŸ“‹ {{ administeringPrescription.comments }}</p>
  } } @else {
  <p>ğŸ“‹ {{ administeringPrescription.instructions }}</p>
  } @if (undoPrescriptionAdministration.comments) {
  <p>ğŸ“ {{ undoPrescriptionAdministration.comments }}</p>
  } @if (isPrescriptionMedication(administeringPrescription)) {
  <div class="buttons">
    <button
      (click)="undoPrescriptionMedication(undoPrescriptionAdministration.id)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âŒ Undo
    </button>
    <button (click)="cancel()" class="button button--secondary-invert">
      â¬…ï¸ Back
    </button>
  </div>
  } @else {
  <div class="buttons">
    <button
      (click)="undoPrescriptionInstruction(undoPrescriptionAdministration.id)"
      class="button button--secondary-invert"
    >
      ğŸ’‰âŒ Undo
    </button>
    <button (click)="cancel()" class="button button--secondary-invert">
      â¬…ï¸ Back
    </button>
  </div>
  }
</div>
} @else {
<div class="filter">
  <div>
    <label for="date"><strong>Date</strong></label>
    <input type="date" id="date" [(ngModel)]="date" (change)="changeDate()" />
  </div>
  <div>
    <p><strong>Rechecks</strong></p>
    <div class="subfilter">
      <div>
        <div class="field">
          <label for="showMeOverdueRechecks">Overdue</label>
          <input
            type="checkbox"
            id="showMeOverdueRechecks"
            [(ngModel)]="showMe.overdueRechecks"
          />
        </div>
        <div class="field">
          <label for="showMeDueRechecks">Due</label>
          <input
            type="checkbox"
            id="showMeDueRechecks"
            [(ngModel)]="showMe.dueRechecks"
          />
        </div>
        <div class="field">
          <label for="showMeDoneRechecks">Done</label>
          <input
            type="checkbox"
            id="showMeDoneRechecks"
            [(ngModel)]="showMe.doneRechecks"
          />
        </div>
      </div>
      <div>
        <div class="field">
          <label for="showMeVeterinarianRechecks">Veterinarian</label>
          <input
            type="checkbox"
            id="showMeVeterinarianRechecks"
            [(ngModel)]="showMe.veterinarianRechecks"
          />
        </div>
        <div class="field">
          <label for="showMeTechnicianRechecks">Technician</label>
          <input
            type="checkbox"
            id="showMeTechnicianRechecks"
            [(ngModel)]="showMe.technicianRechecks"
          />
        </div>
      </div>
    </div>
  </div>
  <div>
    <p><strong>Prescriptions</strong></p>
    <div class="field">
      <label for="showMeNotDuePrescriptions">Not due today</label>
      <input
        type="checkbox"
        id="showMeNotDuePrescriptions"
        [(ngModel)]="showMe.notDuePrescriptions"
      />
    </div>
    <div class="field">
      <label for="showMeDuePrescriptions">Due</label>
      <input
        type="checkbox"
        id="showMeDuePrescriptions"
        [(ngModel)]="showMe.duePrescriptions"
      />
    </div>
    <div class="field">
      <label for="showMeDonePrescriptions">Done</label>
      <input
        type="checkbox"
        id="showMeDonePrescriptions"
        [(ngModel)]="showMe.donePrescriptions"
      />
    </div>
  </div>
</div>
@if (dailyTasksReport$ | async; as report) { @if (performRecheckTask$ | async;
as performRecheckTask) { @if (administerPrescriptionTask$ | async; as
administerPrescriptionTask) { @if (report.loading || performRecheckTask.loading
|| administerPrescriptionTask.loading) {
<spinner></spinner>
} @else if (report.error || performRecheckTask.error ||
administerPrescriptionTask.error) {
<div class="error">Error occurred</div>
} } } @if (report.data) { @if (!shouldShowAreas(report.data)) {
<div class="nothing">
  <h2>Nothing to do</h2>
  <p>
    Looks like there's nothing to do based on the selected filters on this date.
  </p>
</div>
} @for (area of report.data.areas; track area.code) { @if (shouldShowArea(area))
{
<div class="area">
  <h2>
    <span class="area-name">{{ area.name }}</span>
    <span class="summary">
      ğŸ©º {{ area.rechecks }} ğŸ’Š {{ area.prescriptions }}
    </span>
  </h2>
  <div class="pens">
    @for (pen of area.pens; track pen.reference) { @if (shouldShowPen(pen)) {
    <div class="pen">
      <h3>
        <span class="pen-reference">{{ pen.reference }}</span>
        <span class="summary">
          ğŸ©º {{ pen.rechecks }} ğŸ’Š {{ pen.prescriptions }}
        </span>
      </h3>
      <div class="patients">
        @for (patient of pen.patients; track patient.id) { @if
        (shouldShowPatient(patient)) {
        <div class="patient">
          <p>
            ğŸ”—
            <a
              (click)="viewPatient(patient.reference, patient.species.name, patient.id)"
              >{{ patient.reference }}</a
            >
          </p>
          <p>ğŸ¾ {{ patient.species.name }} ({{ patient.variant.name }})</p>
          @if (patient.uniqueIdentifier) {
          <p>ğŸ¨ {{ patient.uniqueIdentifier }}</p>
          }
          <div class="tasks">
            @if (shouldShowRechecks(patient)) {
            <table class="rechecks">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>For</th>
                  <th>Recheck</th>
                  @if (showMe.doneRechecks) {
                  <th>Weight</th>
                  <th>Comments</th>
                  }
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (recheck of patient.rechecks; track recheck.id) { @if
                (shouldShowRecheck(recheck)) {
                <tr>
                  <td>
                    @if (recheck.due == date) { @if (recheck.rechecked) {
                    <span class="done">Done</span>
                    } @else {
                    <span class="due">Due</span>
                    } } @else {
                    <span class="overdue">
                      Overdue ({{ recheck.due | date: 'dd MMM yyyy' }})
                    </span>
                    }
                  </td>
                  <td>{{ getRecheckRoles(recheck.roles) }}</td>
                  <td>{{ recheck.description }}</td>
                  @if (showMe.doneRechecks) {
                  <td>
                    @if (recheck.weightValue && recheck.weightUnit) { {{
                    recheck.weightValue }} {{ getWeightUnit(recheck.weightUnit)
                    }} }
                  </td>
                  <td>{{ recheck.comments }}</td>
                  }
                  <td>
                    @if (!recheck.rechecked) {
                    <div class="buttons buttons--check">
                      <button
                        (click)="performingRecheck = recheck"
                        class="button button--secondary-invert"
                      >
                        ğŸ©º
                      </button>
                    </div>
                    }
                  </td>
                </tr>
                } }
              </tbody>
            </table>
            } @if (shouldShowPrescriptions(patient)) {
            <table class="prescriptions">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Frequency</th>
                  <th>Last dose</th>
                  <th colspan="3">Prescription</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (prescription of getPrescriptions(patient); track
                prescription.id) { @if (shouldShowPrescription(prescription)) {
                <tr>
                  <td>
                    @if (getPrescriptionStatus(prescription) === 'due') {
                    <span class="due">Due</span>
                    } @else if (getPrescriptionStatus(prescription) === 'done')
                    {
                    <span class="done">Done</span>
                    } @else {
                    <span class="not-today"> Not due today </span>
                    }
                  </td>
                  <td>
                    {{ prescription.frequency }}<br />
                    <span class="date">
                      {{ prescription.start | date: 'dd MMM yyyy'}} - {{
                      prescription.end | date: 'dd MMM yyyy'}}</span
                    >
                  </td>
                  <td>
                    @if (getMostRecent(prescription) !== '') { {{
                    getDurationSinceMostRecent(prescription) }} ago<br />
                    <span class="date">
                      {{ getMostRecent(prescription) | date: 'dd MMM yyyy HH:mm'
                      }}
                    </span>
                    }
                  </td>
                  @if (isPrescriptionMedication(prescription)) {
                  <td>
                    {{ prescription.medication.activeSubstance }}<br />
                    <span class="brands">
                      {{ getBrands(prescription.medication) }}
                    </span>
                  </td>
                  <td>
                    {{ prescription.medicationConcentration.form }}, {{
                    prescription.medicationConcentration.concentrationValue }}
                    {{ prescription.medicationConcentration.concentrationUnit
                    }}<br />
                    {{ prescription.administrationMethod.description }} ({{
                    prescription.administrationMethod.code }})
                  </td>
                  <td class="quantity">
                    {{ prescription.quantityValue }} {{
                    prescription.quantityUnit }}
                  </td>
                  } @else {
                  <td colspan="3">{{ prescription.instructions }}</td>
                  }
                  <td>
                    <div class="buttons buttons--check">
                      @for (administration of
                      getTodayPrescriptionAdministrations(prescription); track
                      administration.id) {
                      <button
                        (click)="askUndoPrescriptionAdministration(prescription, administration)"
                        class="button button--secondary-invert"
                      >
                        âœ”ï¸
                      </button>
                      } @for (i of
                      getOutstandingAdministrationsCount(prescription); track i)
                      {
                      <button
                        (click)="administeringPrescription = prescription"
                        class="button button--secondary-invert"
                      >
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                      </button>
                      }
                    </div>
                  </td>
                </tr>
                @if (isPrescriptionMedication(prescription) &&
                prescription.comments) {
                <tr>
                  <td colspan="3"></td>
                  <td colspan="3">{{ prescription.comments }}</td>
                  <td></td>
                </tr>
                } } }
              </tbody>
            </table>
            }
          </div>
        </div>
        } }
      </div>
    </div>
    } }
  </div>
</div>
} } } } }
