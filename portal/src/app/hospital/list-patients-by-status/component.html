<div class="filter">
  <div class="field">
    <label for="search">Filter</label>
    <input
      type="text"
      id="search"
      autocomplete="off"
      (input)="search$.next($any($event.target).value)"
    />
  </div>
  <div class="field">
    <label for="pageSize">Page size</label>
    <select
      id="pageSize"
      [ngModel]="pageSize$ | async"
      (ngModelChange)="pageSize$.next($event)"
    >
      <option [value]="25">25</option>
      <option [value]="50">50</option>
      <option [value]="100">100</option>
    </select>
  </div>
  <div class="field">
    <label for="pages">&nbsp;</label>
    @if (totalPages$ | async; as totalPages) {
    <div class="pagination">
      <button class="nav" (click)="goToPage(1)" [disabled]="page === 1">
        &#x219E;
      </button>
      <button class="nav" (click)="prevPage()" [disabled]="page === 1">
        &larr;
      </button>
      @for (p of pages(totalPages); track p) {
      <button (click)="goToPage(p)" [class.active]="p === page">{{ p }}</button>
      }
      <button class="nav" (click)="nextPage()" [disabled]="page === totalPages">
        &rarr;
      </button>
      <button
        class="nav"
        (click)="goToPage(totalPages)"
        [disabled]="page === totalPages"
      >
        &#x21A0;
      </button>
    </div>
    }
  </div>
</div>

@if (patients$ | async; as patients) { @if (patients.loading) {
<spinner></spinner>
} @else if (patients.error) {
<div class="error">Error occurred</div>
} @else if (patients.data) { @if (_status === PatientStatus.PendingInitialExam)
{
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Suspected species</th>
      <th>Date admitted</th>
      <th>Initial location</th>
      <th>Admission reason</th>
    </tr>
  </thead>
  <tbody>
    @for (patient of patients.data; track patient.id) {
    <tr>
      <td>
        <a (click)="view(patient)">{{ patient.reference }}</a>
      </td>
      <td>{{ patient.suspectedSpecies.description }}</td>
      <td>{{ patient.admitted | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>{{ patient.initialLocation.description }}</td>
      <td>{{ formatAdmissionReasons(patient) }}</td>
    </tr>
    }
  </tbody>
</table>
} @else if (_status === PatientStatus.Inpatient || _status
===PatientStatus.ReadyForRelease) {
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Species</th>
      <th>Variant</th>
      <th>Pen</th>
      <th>Date admitted</th>
      <th>Stay</th>
    </tr>
  </thead>
  <tbody>
    @for (patient of patients.data; track patient.id) {
    <tr>
      <td>
        <a (click)="view(patient)">{{ patient.reference }}</a>
      </td>
      <td>{{ patient.species?.name }}</td>
      <td>{{ patient.speciesVariant?.name }}</td>
      @if (patient.pen) {
      <td>
        {{ patient.pen.reference }} @if (patient.uniqueIdentifier) {
        <span class="unique-identifier">{{ patient.uniqueIdentifier }}</span>
        }
      </td>
      } @else {
      <td>
        <span class="outdated">Homeless</span>
      </td>
      }
      <td>{{ patient.admitted | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>
        @if (patient.isLongTerm) {
        <span class="long-term">Long term</span>
        } @if (patient.isOutdated) {
        <span class="outdated">Outdated</span>
        } {{ duration(patient) }}
      </td>
    </tr>
    }
  </tbody>
</table>
} @else if (_status === PatientStatus.PendingHomeCare) {
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Species</th>
      <th>Variant</th>
      <th>Pen</th>
      <th>Date admitted</th>
      <th>Home care requested</th>
    </tr>
  </thead>
  <tbody>
    @for (patient of patients.data; track patient.id) {
    <tr>
      <td>
        <a (click)="view(patient)">{{ patient.reference }}</a>
      </td>
      <td>{{ patient.species?.name }}</td>
      <td>{{ patient.speciesVariant?.name }}</td>
      @if (patient.pen) {
      <td>
        {{ patient.pen.reference }} @if (patient.uniqueIdentifier) {
        <span class="unique-identifier">{{ patient.uniqueIdentifier }}</span>
        }
      </td>
      } @else {
      <td>
        <span class="outdated">Homeless</span>
      </td>
      }
      <td>{{ patient.admitted | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>
        {{ patient.homeCareRequests[0]?.requested | date: 'dd MMM yyyy HH:mm' }}
      </td>
    </tr>
    }
  </tbody>
</table>
} @else if (_status === PatientStatus.ReceivingHomeCare) {
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Species</th>
      <th>Variant</th>
      <th>Date admitted</th>
      <th>Home care since</th>
      <th>Home care pen</th>
      <th>Home carer</th>
    </tr>
  </thead>
  <tbody>
    @for (patient of patients.data; track patient.id) {
    <tr>
      <td>
        @if (patient.lastMessageSentByOrphanFeeder) { ğŸ”´ }
        <a (click)="view(patient)">{{ patient.reference }}</a>
      </td>
      <td>{{ patient.species?.name }}</td>
      <td>{{ patient.speciesVariant?.name }}</td>
      <td>{{ patient.admitted | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>
        @for (request of patient.homeCareRequests; track request.id) { {{
        request.pickup | date: 'dd MMM yyyy HH:mm' }} }
      </td>
      @if (patient.pen) {
      <td>
        {{ patient.pen.reference }} @if (patient.uniqueIdentifier) {
        <span class="unique-identifier">{{ patient.uniqueIdentifier }}</span>
        }
      </td>
      } @else {
      <td>
        <span class="outdated">Homeless</span>
      </td>
      }
      <td>
        @for (request of patient.homeCareRequests; track request.id) { {{
        request.responder?.firstName }} {{ request.responder?.lastName }} }
      </td>
    </tr>
    }
  </tbody>
</table>
} @else if (_status === PatientStatus.Dispositioned) {
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Species</th>
      <th>Variant</th>
      <th>Date admitted</th>
      <th>Date dispositioned</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    @for (patient of patients.data; track patient.id) {
    <tr>
      <td>
        <a (click)="view(patient)">{{ patient.reference }}</a>
      </td>
      <td>{{ patient.species?.name }}</td>
      <td>{{ patient.speciesVariant?.name }}</td>
      <td>{{ patient.admitted | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>{{ patient.dispositioned | date: 'dd MMM yyyy HH:mm' }}</td>
      <td>{{ getDisposition(patient) }}</td>
    </tr>
    }
  </tbody>
</table>
} } }
